<!html>
<html lang="en">

<head>
	<title>Rainhawk.js Tests</title>
	<script type="text/javascript" src="rainhawk.js"></script>
	<style type="text/css">
		pre {
			line-height: 18px;
			padding: 0;
			margin: 0;
		}
	</style>
</head>

<body>
	<pre>[+] Running tests.</pre>
	<script type="text/javascript">
		/**
		 * Populate some test variables.
		 */

		var errors = 0;
		var started = new Date().getTime();
		var username;
		var name = "jswrapper";
		var full_name;

		/**
		 * Create a debug function.
		 */

		function debug(message) {
			if(message.substring(0, 3) == "[!]") {
				errors++;
			}

			var pre = document.createElement("pre");
			pre.innerHTML = message;
			document.body.appendChild(pre);
		}

		/**
		 * Set the API key.
		 */

		rainhawk.apiKey = "eSQpirMYxjXUs8xIjjaUo72gutwDJ4CP";

		/**
		 * Define the tests to perform in an array with functions and callbacks
		 * so that we can keep references to which test we're on.
		 */

		var tests = [
			/**
			 * Send a ping request to the API and output the user's Mashape
			 * username.
			 */

			function(done) {
				debug("[+] Checking that the API is online...");

				rainhawk.ping(function(data) {
					username = data.mashape_user;
					full_name = username + "." + name;

					debug("[+] --> Found username: '" + username + "'.");
					done();
				}, function(message) {
					debug("[!] Could not ping the service - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to fetch all of the user's datasets.
			 */

			function(done) {
				debug("[+] Fetching list of datasets that we have access to...");

				rainhawk.datasets.list(function(datasets) {
					var inner = false;

					for(var i in datasets) {
						var dataset = datasets[i];

						if(dataset.name == full_name) {
							debug("[+] --> Found '" + full_name + "', removing...");
							inner = true;

							rainhawk.datasets.delete(full_name, function() {
								done();
							}, function(message) {
								debug("[!] Could not delete dataset - " + message);
								done();
							});
						}
					}

					if(!inner) {
						done();
					}
				}, function(message) {
					debug("[!] Could not list our datasets - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to create our test dataset.
			 */

			function(done) {
				debug("[+] Creating new dataset '" + name + "'...");

				rainhawk.datasets.create(name, "An example dataset from the JS class for testing.", function(dataset) {
					name = full_name;
					delete full_name;
					done();
				}, function(message) {
					debug("[!] Could not create dataset - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to fetch information about one dataset.
			 */

			function(done) {
				debug("[+] Fetching the new dataset, '" + name + "'...");

				rainhawk.datasets.info(name, function(dataset) {
					debug(JSON.stringify(dataset));
					done();
				}, function(message) {
					debug("[!] Could not fetch the dataset's information - " + message);
					done();
				});
			},

			/**
			 * Output a finished message!
			 */

			function(done) {
				if(errors == 0) {
					debug("[+] Done! All tests passed in " + ((new Date().getTime() - started) / 1000) + " second(s).");
				} else {
					debug("[!] Done! Some tests failed in " + ((new Date().getTime() - started) / 1000) + " second(s).");
				}

				done();
			}
		];

		/**
		 * Run all of the tests synchronously so that we don't break the order of
		 * operations and invalidate the tests by law.
		 */

		var i = 0;
		var done = false;

		setInterval(function() {
			if(done && tests[i]) {
				done = false;
				tests[i](function() { done = true; i++; });
			}
		}, 10);

		tests[i](function() { done = true; i++; });
	</script>
</body>

</html>