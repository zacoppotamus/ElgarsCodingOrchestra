<!html>
<html lang="en">

<head>
	<title>Rainhawk.js Tests</title>
	<script type="text/javascript" src="rainhawk.js"></script>
	<style type="text/css">
		pre {
			line-height: 18px;
			padding: 0;
			margin: 0;
		}
	</style>
</head>

<body>
	<pre>[+] Running tests.</pre>
	<script type="text/javascript">
		/**
		 * Populate some test variables.
		 */

		var errors = 0;
		var started = new Date().getTime();
		var username;
		var name = "jswrapper";
		var full_name;

		/**
		 * Create a debug function.
		 */

		function debug(message) {
			if(message.substring(0, 3) == "[!]") {
				errors++;
			}

			var pre = document.createElement("pre");
			pre.innerHTML = message;
			document.body.appendChild(pre);
		}

		/**
		 * Set the API key.
		 */

		rainhawk.apiKey = "eSQpirMYxjXUs8xIjjaUo72gutwDJ4CP";

		/**
		 * Define the tests to perform in an array with functions and callbacks
		 * so that we can keep references to which test we're on.
		 */

		var tests = [
			/**
			 * Send a ping request to the API and output the user's Mashape
			 * username.
			 */

			function(done) {
				debug("[+] Checking that the API is online...");

				rainhawk.ping(function(data) {
					username = data.mashape_user;
					full_name = username + "." + name;

					debug("[+] --> Found username: '" + username + "'.");
					done();
				}, function(message) {
					debug("[!] Could not ping the service - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to fetch all of the user's datasets.
			 */

			function(done) {
				debug("[+] Fetching list of datasets that we have access to...");

				rainhawk.datasets.list(function(datasets) {
					var inner = false;

					for(var i in datasets) {
						var dataset = datasets[i];

						if(dataset.name == full_name) {
							debug("[+] --> Found '" + full_name + "', removing...");
							inner = true;

							rainhawk.datasets.delete(full_name, function(deleted) {
								debug("[+] Deleted: " + deleted);
								done();
							}, function(message) {
								debug("[!] Could not delete dataset - " + message);
								done();
							});
						}
					}

					if(!inner) {
						done();
					}
				}, function(message) {
					debug("[!] Could not list our datasets - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to create our test dataset.
			 */

			function(done) {
				debug("[+] Creating new dataset '" + name + "'...");

				rainhawk.datasets.create(name, "An example dataset from the JS class for testing.", function(dataset) {
					name = full_name;
					delete full_name;
					done();
				}, function(message) {
					debug("[!] Could not create dataset - " + message);
					done();
				});
			},

			/**
			 * Send a request to the API to fetch information about one dataset.
			 */

			function(done) {
				debug("[+] Fetching the new dataset, '" + name + "'...");

				rainhawk.datasets.info(name, function(dataset) {
					debug(JSON.stringify(dataset));
					done();
				}, function(message) {
					debug("[!] Could not fetch the dataset's information - " + message);
					done();
				});
			},

			/**
			 * Insert one row of data into the dataset.
			 */

			function(done) {
				debug("[+] Inserting one row into '" + name + "'.");

				var row = {
					name: "John",
    				age: 20,
    				weight: 320,
    				roles: ["admin", "manager", "content"]
    			};

    			rainhawk.data.insert(name, row, function(row) {
    				debug(JSON.stringify(row));
    				done();
    			}, function(message) {
    				debug("[!] Could not insert data - " + message);
    			});
    		},

    		/**
    		 * Upload a CSV to the dataset.
    		 */

    		function(done) {
    			debug("[+] Uploading 'test_data.csv' to the dataset...");

    			var file = new Blob(["symbol,date,price\n" +
					"MSFT,Jan 1 2000,39.81\n" +
					"MSFT,Feb 1 2000,36.35\n" +
					"MSFT,Mar 1 2000,43.22\n" +
					"MSFT,Apr 1 2000,28.37\n" +
					"MSFT,May 1 2000,25.45\n" +
					"MSFT,Jun 1 2000,32.54\n"
				], {
					type: "text/csv"
				});

				rainhawk.data.upload(name, file, "csv", function(rows) {
    				debug(JSON.stringify(rows));
    				done();
    			}, function(message) {
    				debug("[!] Could not upload data - " + message);
    			});
    		},

            /**
             * Apply automatic constraints to fields.
             */

            function(done) {
                debug("[+] Automatically detecting constraints and applying them...");

                rainhawk.constraints.add(name, null, null, function(detected) {
                    debug(JSON.stringify(detected));
                    done();
                }, function(message) {
                    debug("[!] Could not add constraints - " + message);
                });
            },

            /**
             * List constraints on the dataset.
             */

            function(done) {
                debug("[+] Listing the constraints being applied to the data...");

                rainhawk.constraints.list(name, function(constraints) {
                    debug(JSON.stringify(constraints));
                    done();
                }, function(message) {
                    debug("[!] Could not list constraints - " + message);
                });
            },

            /**
             * Remove the constraint on price.
             */

            function(done) {
                debug("[+] Removing the constraint on 'price'...");

                rainhawk.constraints.remove(name, "price", function(removed) {
                    debug("[+] Removed: " + removed);
                    done();
                }, function(message) {
                    debug("[!] Could not remove constraint - " + message);
                });
            },

    		/**
    		 * Select some rows using a query.
    		 */

    		function(done) {
    			debug("[+] Selecting all rows that are content creators...");

    			var query = {
    				roles: {
        				'$in': ["content"]
     				}
				};

				rainhawk.data.select(name, {
					query: query
				}, function(data) {
					debug(JSON.stringify(data.results));
					done();
				}, function(message) {
					debug("[!] Could not select data - " + message);
					done();
				});
    		},

    		/**
    		 * Delete the test data.
    		 */

    		function(done) {
    			debug("[+] Deleting our test data...");

    			var query = {
    				name: "John"
    			};

    			rainhawk.data.delete(name, query, function(deleted) {
					debug("[+] Deleted: " + deleted + " row(s).");
					done();
				}, function(message) {
					debug("[!] Could not delete data - " + message);
					done();
				});
    		},

            /**
             * Delete the test dataset.
             */

            function(done) {
                debug("[+] Removing the test dataset '" + name + "'...");

                rainhawk.datasets.delete(name, function(deleted) {
                    debug("[+] Deleted: " + deleted);
                    done();
                }, function(message) {
                    debug("[!] Could not delete dataset - " + message);
                    done();
                });
            },

			/**
			 * Output a finished message!
			 */

			function(done) {
				var taken = (new Date().getTime() - started) / 1000;

				if(errors == 0) {
					debug("[+] Done! All tests passed in " + taken + " second(s).");
				} else {
					debug("[!] Done! Some tests failed in " + taken + " second(s).");
				}

				done();
			}
		];

		/**
		 * Run all of the tests synchronously so that we don't break the order of
		 * operations and invalidate the tests by law.
		 */

		var i = 0;
		var done = false;

		setInterval(function() {
			if(done && tests[i]) {
				done = false;
				tests[i](function() { done = true; i++; });
			}
		}, 10);

		tests[i](function() { done = true; i++; });
	</script>
</body>

</html>